const t=/```\s*<[Cc]heckbox>(.*?)<\/[Cc]heckbox>\s*```/is,s=`<style>.roleplay_checkbox_back{background:linear-gradient(160deg,rgba(45,45,45,.75),rgba(35,35,35,.85));border-radius:14px;box-shadow:0 10px 28px rgba(0,0,0,.15),0 3px 10px rgba(0,0,0,.12);padding:16px 18px;border:1px solid hsla(0,0%,100%,.06);max-width:100%;margin:20px 0;position:relative;overflow:hidden}.roleplay_checkbox_slider{display:flex;align-items:stretch;overflow-x:auto;overflow-y:hidden;gap:12px;padding:8px 4px;scroll-behavior:smooth;scrollbar-width:thin;scrollbar-color:rgba(160,160,160,.4) transparent}.roleplay_checkbox_slider::-webkit-scrollbar{height:6px}.roleplay_checkbox_slider::-webkit-scrollbar-track{background:rgba(0,0,0,.1);border-radius:3px}.roleplay_checkbox_slider::-webkit-scrollbar-thumb{background:rgba(160,160,160,.4);border-radius:3px;transition:background .3s ease}.roleplay_checkbox_slider::-webkit-scrollbar-thumb:hover{background:rgba(180,180,180,.6)}.roleplay_checkbox_item{position:relative;background:rgba(50,50,50,.65);border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,.1);padding:14px 16px;cursor:default;border:1px solid hsla(0,0%,100%,.04);transition:all .25s cubic-bezier(.25,.8,.25,1);overflow:hidden;display:flex;flex-direction:column;justify-content:center;align-items:flex-start;z-index:1;color:#d8d8d8;font-weight:400;line-height:1.5;min-width:180px;max-width:280px;flex-shrink:0;min-height:80px}.roleplay_checkbox_item::after{content:"";position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,rgba(90,90,90,.06) 0%,transparent 70%);opacity:0;transition:opacity .3s ease;z-index:-1}.roleplay_checkbox_item:before{content:"";position:absolute;top:0;left:0;width:3px;height:100%;background:linear-gradient(to bottom,rgba(160,160,160,.6),rgba(180,180,180,.3));transform:scaleY(0);transform-origin:top;transition:transform .3s cubic-bezier(.4,0,.2,1)}.last_mes .roleplay_checkbox_item{cursor:pointer}.last_mes .roleplay_checkbox_item:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 8px 20px rgba(0,0,0,.2);background:rgba(58,58,58,.85);border-color:rgba(200,200,200,.15)}.last_mes .roleplay_checkbox_item:hover::after{opacity:1}.last_mes .roleplay_checkbox_item:hover .roleplay_checkbox_content{color:#e2e2e2}.last_mes .roleplay_checkbox_item:hover:before{transform:scaleY(1)}.roleplay_checkbox_title{font-size:.94em;font-weight:600;color:#f0f0f0;letter-spacing:.02em;margin-bottom:8px}.roleplay_checkbox_content{font-size:.94em;line-height:1.55;color:#c6c6c6;transition:color .25s ease;letter-spacing:.015em}@media(max-width:768px){.roleplay_checkbox_back{padding:12px 14px}.roleplay_checkbox_slider{gap:8px;padding:6px 2px}.roleplay_checkbox_item{padding:12px 14px;min-width:150px;max-width:220px;min-height:70px}.roleplay_checkbox_title{font-size:.9em}.roleplay_checkbox_content{font-size:.9em;line-height:1.4}.roleplay_checkbox_slider::-webkit-scrollbar{height:4px}}@media(prefers-reduced-motion:reduce){.roleplay_checkbox_item{transition:none}.roleplay_checkbox_item::before,.roleplay_checkbox_item::after{transition:none}.roleplay_checkbox_content,.roleplay_checkbox_title{transition:none}.roleplay_checkbox_slider{scroll-behavior:auto}}</style>`;function e(e){const a=getChatMessages(e)[0]?.message?.match(t);if(!a)return;const o=n(a[1]),r=retrieveDisplayedMessage(e),s=r.find('.roleplay_checkbox, pre:contains("<Checkbox>")');s.length>0&&s.remove(),r.append(o)}function n(e){const t=$('<div class="roleplay_checkbox">').append(s),n=$('<div class="roleplay_checkbox_slider">');return[...e.matchAll(/(.+?)[:：]\s*(.+)/gm)].map(e=>({title:e[1],content:e[2].replace(/^\$\{(.+)\}$/,"$1").replace(/^「(.+)」$/,"$1")})).forEach(({title:e,content:t})=>{const a=$('<div class="roleplay_checkbox_item" tabindex="1">').on("click",function(){$(this).parents(".last_mes").length>0&&triggerSlash(`/send ${$(this).find(".roleplay_checkbox_content").text().trim()} || /trigger`)}).append(`<span class="roleplay_checkbox_title"><strong>${e}</strong></span>`).append(`<span class="roleplay_checkbox_content">${t}</span>`);n.append(a)}),t.append($('<div class="roleplay_checkbox_back">').append(n)),t}function a(){$("#chat").children(".mes[is_user='false'][is_system='false']").each((t,n)=>e(Number(n.getAttribute("mesid"))))}function o(){const e=$('.mes[is_user="false"][is_system="false"]').last().find(".roleplay_checkbox_content").map((e,t)=>$(t).text().trim()).toArray();triggerSlash(`/send ${0===e.length?"继续推进":_.sample(e)} || /trigger`)}let l=null;function c(){null!==l&&(setTimeout(o,_.get(getVariables({type:"global"}),["【可点击的选择框】","自动推进发送间隔"],3e3)),++l,l===_.get(getVariables({type:"global"}),["【可点击的选择框】","自动推进循环次数"],-1)&&i())}function i(){eventRemoveListener(tavern_events.CHARACTER_MESSAGE_RENDERED,c),l=null,toastr.success("已停止自动推进","【可点击的选择框】")}$(()=>{a(),eventOn(tavern_events.CHAT_CHANGED,a),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,e),eventOn(tavern_events.MESSAGE_UPDATED,e),eventOn(tavern_events.MESSAGE_SWIPED,e),eventOn(tavern_events.MESSAGE_DELETED,()=>setTimeout(a,1e3)),eventOnButton("设置循环次数",(async()=>{const t=Number(await SillyTavern.callGenericPopup("设置循环次数 (-1 为直到按下 '停止自动推进')",SillyTavern.POPUP_TYPE.INPUT,_.get(getVariables({type:"global"}),["【可点击的选择框】","自动推进循环次数"],"-1")));-1!==t&&t<=0?toastr.error("循环次数要么是 -1, 要么是大于 0 的整数"):(insertOrAssignVariables({"【可点击的选择框】":{自动推进循环次数:t}},{type:"global"}),-1===t?toastr.success('已设置推进次数为 -1, 即直到按下 "停止自动推进" 才会停止',"【可点击的选择框】"):toastr.success(`已设置推进次数为 ${t} 次`,"【可点击的选择框】"))})),eventOnButton("设置发送间隔",(async()=>{const t=Number(await SillyTavern.callGenericPopup("设置发送间隔 (单位: 毫秒)",SillyTavern.POPUP_TYPE.INPUT,_.get(getVariables({type:"global"}),["【可点击的选择框】","自动推进发送间隔"],"3000")));t<=0?toastr.error("发送间隔必须大于 0"):(insertOrAssignVariables({"【可点击的选择框】":{自动推进发送间隔:t}},{type:"global"}),toastr.success(`已设置发送间隔为 ${t} 毫秒`,"【可点击的选择框】"))})),eventOnButton("启动自动推进",(()=>{null===l?(l=0,c(),eventOn(tavern_events.CHARACTER_MESSAGE_RENDERED,c),toastr.success("已开启自动推进","【可点击的选择框】")):toastr.error("自动推进在之前已开启, 请先停止自动推进")})),eventOnButton("停止自动推进",i)});
